---
title: "Benchmarks"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```r

install.packages('pak')

pak::pkg_install(pkg = c(
  'abdiv, 'GUniFrac', 'kasperskytte/ampvis2', 'microbenchmark', 'phyloseq', 
  'rbiom', 'vegan' ))
  
version$version.string
#> [1] "R version 4.5.1 (2025-06-13 ucrt)"

(n_cpus <- parallelly::availableCores()[[1]])
#> 6

sapply(FUN = packageDescription, fields = 'Version', c(
  'abdiv', 'ampvis2', 'GUniFrac', 'phyloseq', 'rbiom', 'vegan' ))
#>    abdiv  ampvis2  GUniFrac  phyloseq    rbiom    vegan 
#>  "0.2.0"  "2.8.9"     "1.8"  "1.52.0"  "2.2.1"  "2.7-1"

options(rbiom.cache_dir = 'FALSE')


# GEMS dataset has 1006 Samples
gems_mtx  <- as.matrix(rbiom::gems)
gems_tmtx <- t(gems_mtx)

microbenchmark::microbenchmark(
  times   = 100,
  control = list('warmup'),
  unit    = 'milliseconds',
  rbiom_bray = rbiom::bdiv_distmat(gems_mtx, 'bray'),
  rbiom_eucl = rbiom::bdiv_distmat(gems_mtx, 'euclidean'),
  rbiom_manh = rbiom::bdiv_distmat(gems_mtx, 'manhattan'),
  rbiom_jacc = rbiom::bdiv_distmat(gems_mtx, 'jaccard'),
  vegan_bray = vegan::vegdist(gems_tmtx, 'bray'),
  vegan_eucl = vegan::vegdist(gems_tmtx, 'euclidean'),
  vegan_manh = vegan::vegdist(gems_tmtx, 'manhattan'),
  vegan_jacc = vegan::vegdist(gems_tmtx, 'jaccard') )
#> Unit: milliseconds
#>        expr       min        lq      mean    median        uq       max neval
#>  rbiom_bray  392.8480  411.9878  452.1987  422.0814  434.1527  957.1814   100
#>  rbiom_eucl  376.0261  390.7452  432.1333  399.3859  409.2418  745.7182   100
#>  rbiom_manh  398.1766  410.4937  464.1193  419.8621  434.3308  783.0719   100
#>  rbiom_jacc  394.6261  413.1661  449.6972  425.6042  438.0386  789.8647   100
#>  vegan_bray 1684.6904 1906.3394 1973.9582 1965.0728 2016.4819 2871.2950   100
#>  vegan_eucl 1561.9423 1782.3277 1867.9286 1846.6766 1928.6212 2455.4238   100
#>  vegan_manh 1564.6130 1789.2117 1868.4523 1840.0278 1937.3641 2334.4634   100
#>  vegan_jacc 1779.2507 1922.1949 2008.4732 1982.0686 2054.5181 2462.9468   100


# HMP50 dataset has 50 Samples
hmp50      <- rbiom::hmp50
hmp50_phy  <- rbiom::convert_to_phyloseq(hmp50)
hmp50_mtx  <- as.matrix(hmp50)
hmp50_tmtx <- t(hmp50_mtx)
hmp50_tree <- hmp50$tree

cl <- parallel::makeCluster(n_cpus)
doParallel::registerDoParallel(cl)

microbenchmark::microbenchmark(
  times    = 100,
  control  = list('warmup'),
  unit     = 'milliseconds',
  rbiom    = rbiom::bdiv_distmat(hmp50, bdiv='UniFrac', weighted=TRUE, normalized=TRUE),
  phyloseq = phyloseq::UniFrac(hmp50_phy, weighted=TRUE, normalized=TRUE, parallel=TRUE),
  GUniFrac = as.dist(GUniFrac::GUniFrac(hmp50_tmtx, hmp50_tree, alpha=1, verbose=FALSE)[[1]][,,1]) )
#> Unit: milliseconds
#>      expr      min       lq       mean    median        uq       max neval
#>     rbiom   6.9196   7.4851   8.044243   7.77585   8.28915   20.7615   100
#>  phyloseq 289.9793 305.0021 386.685350 309.46380 314.67285 6490.5718   100
#>  GUniFrac  89.6219  92.9128 106.370146  95.07380 102.02750  680.5833   100

parallel::stopCluster(cl)


# ampvis2 conflicts with phyloseq cluster, so run separately
microbenchmark::microbenchmark(
  times    = 100,
  control  = list('warmup'),
  unit     = 'milliseconds',
  ampvis2  = {
    ampvis2:::dist.unifrac(hmp50_mtx, hmp50_tree, weighted=TRUE, normalise=TRUE, num_threads=n_cpus)
    doParallel::stopImplicitCluster()
  })
#> Unit: milliseconds
#>     expr      min       lq     mean   median       uq      max neval
#>  ampvis2 3222.314 3331.174 3411.738 3390.686 3447.769 3923.836   100



# vegan::vegdist(method = 'bray')
  - animalcules
  - microViz
  - ampvis2
  - tidytacos
  - mia
  - microbiome
  - microeco
  - phyloseq

# rbiom::bdiv_distmat(bdiv = 'Bray-Curtis')


# GUniFrac::GUniFrac()
  - animalcules
  - microViz
  - microeco

# ampvis2:::dist.unifrac()

# phyloseq::UniFrac()
  - microbiome
  - tidytacos

# rbiom::bdiv_distmat(bdiv = 'UniFrac')
  - mia



# animalcules:
   - Beta div integrated into plotting functions.
   - Uses vegan::vegdist for bray and jaccard.
   - Uses GUniFrac and tree derived from tax_table for unifrac.

# microViz:
   - Uses phyloseq::distance() or GUniFrac (with phy_tree).

# ampvis2:
   - Uses vegan::vegdist()
   - Custom dist.unifrac(), a parallelized function written in R.
   
# tidytacos:
   - Uses vegan::vegdist() and phyloseq::UniFrac().
   
# mia:
   - Uses vegan::vegdist() and rbiom::unifrac().

# microbiome:
   - Uses vegan::vegdist()
   - Uses phyloseq::distance(). [microbiome::divergence()]

# microeco:
   - Uses vegan::vegdist() and GUniFrac::GUniFrac().
   - [microeco::microtable$new()$cal_betadiv()]

# phyloseq:
   - Uses vegan::vegdist()
   - Custom fastUniFrac(), a parallelized function written in R.

# phylosmith:
   - Uses vegan::vegdist() [phylosmith::pcoa_phyloseq].

# vegan:
   - Custom non-parallel C implementation.
   - No unifrac.
   
# GUniFrac:
   - Custom non-parallel C implementation of Unifrac.

```
