---
title: "Benchmark"
author: "Daniel Smith, PhD"
date: "7/2/2018"
output: html_document
---

## Overview

Here we will compare rbiom to similar packages by measuring the time taken to complete common operations on a representative dataset.

## Create Test Environment

For our tests, we'll use a virtual machine on Amazon Web Service's Elastic Compute Cloud. Specifically:
* US-West region
* AMI 482e6430 ([QIIME 2 Core](https://s3-us-west-2.amazonaws.com/qiime2-data/distro/core/aws-amis.txt))
* c3.8xlarge instance type (32 virtual CPUs)
* 20 GiB General Purpose SSD (GP2) Storage on Root Volume

Both the username and password are 'qiime2'. On this instance, qiime2 is already configured. The following will download and install rbiom, phyloseq, and usearch as well as the test dataset.

```bash
sudo apt-get install build-essential gfortran libssl-dev unzip
export TAR=/bin/tar

R -e 'source("http://bioconductor.org/biocLite.R"); biocLite(c("phyloseq", "rhdf5"))'
R -e 'install.packages(c("devtools", "doParallel"), repos="http://cran.us.r-project.org");'
R -e 'devtools::install_git("https://github.com/cmmr/rbiom.git")'

wget https://s3.amazonaws.com/jplab/share/30d/usearch10.0.240
chmod a+x usearch10.0.240

wget https://raw.githubusercontent.com/cmmr/rbiom/master/vignettes/data/hmp500.biom
R -e 'x <- rbiom::read.biom("hmp500.biom"); rbiom::write.tree(x$phylogeny, "hmp500.tre")'
R -e 'x <- rbiom::read.biom("hmp500.biom"); x$taxonomy <- NULL; rbiom::write.biom(x, "hmp500.tab", "tab")'
```

Create four scripts, one per program. These scripts will be the minimal steps needs to read in a biom file and newick, compute a distance matrix, then save the results to a tsv file.

```bash

cat > rbiom.r << EOF
dm <- rbiom::unifrac(
  biom     = rbiom::read.biom("hmp500.tab"),
  tree     = rbiom::read.tree("hmp500.tre"), 
  weighted = TRUE )
write.table(as.matrix(dm), "rbiom_dm.tsv", sep="\t", quote=FALSE)
EOF


cat > phyloseq.r << EOF
ncores <- parallel::detectCores()
doParallel::registerDoParallel(parallel::makeCluster(ncores))

dm <- phyloseq::UniFrac(
  phy        = phyloseq::import_biom("hmp500.tab", "hmp500.tre"), 
  weighted   = TRUE, 
  normalized = FALSE, 
  parallel   = TRUE )
write.table(as.matrix(dm), "phyloseq_dm.tsv", sep="\t", quote=FALSE)
EOF


cat > qiime2.sh << EOF
qiime tools import --input-path hmp500.tab --output-path hmp500.biom --type FeatureTable[Frequency] --source-format BIOMV100Format
qiime tools import --input-path hmp500.tre --output-path hmp500.tre --type Phylogeny[Rooted] --source-format NewickFormat
qiime diversity beta-phylogenetic-alt --i-table hmp500.biom.qza --i-phylogeny hmp500.tre.qza --p-metric unweighted_unifrac --output-dir qiime_out --p-n-jobs 32
qiime tools export --output-dir qiime_out qiime_out/distance_matrix.qza
mv qiime_out/distance-matrix.tsv qiime2_dm.tsv
rm -rf qiime_out
EOF


cat > usearch.sh << EOF
./usearch10.0.240 -beta_div hmp500.tab -metrics unifrac -tree hmp500.tre
mv unifrac.txt unifrac_dm.tsv
rm unifrac.sorted.txt
rm unifrac.tree
EOF

```


Finally, execute and time each script.
```bash
/usr/bin/time Rscript rbiom.r
/usr/bin/time Rscript phyloseq.r
/usr/bin/time /bin/sh qiime2.sh
/usr/bin/time /bin/sh usearch.sh
```
